<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Data Viewer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Industrial Sci-Fi Theme Colors */
        :root {
            --bg-dark: #111827; /* Darkest Navy/Gray */
            --card-dark: #1f2937; /* Dark Gray for panels */
            --accent-neon: #06b6d4; /* Cyan 500 */
        }

        body {
            font-family: 'Inter', 'Space Mono', sans-serif;
            background-color: var(--bg-dark);
            color: #d1d5db; /* Light Gray text */
        }
        
        .container-card {
            background-color: var(--card-dark);
            border: 1px solid #374151; /* Subtle border */
            border-radius: 0.5rem;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); /* Soft neon glow */
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Custom scrollbar for the industrial theme */
        .table-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-neon); 
            border-radius: 4px;
        }
        .table-scroll-container::-webkit-scrollbar-track {
            background-color: #374151; /* Dark track */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center items-start">

    <div class="w-full max-w-6xl space-y-8">
        <header class="text-center p-6 container-card">
            <h1 class="text-3xl font-bold text-cyan-400 font-mono tracking-widest">KANBAN SYSTEM LOG</h1>
            <p id="status-message" class="text-sm mt-2 text-gray-400">Initializing Firebase Connection...</p>
        </header>
        
        <!-- Data Table Display -->
        <div class="p-6 rounded-xl container-card">
            <h2 class="text-2xl font-semibold text-cyan-400 mb-4 border-b border-cyan-400/50 pb-2">Kanban Events</h2>
            
            <div id="data-display-container" class="overflow-x-auto table-scroll-container">
                <p id="loading-message" class="text-center text-gray-400 py-8">Awaiting Data Transmission...</p>
                <table id="kanban-table" class="min-w-full divide-y divide-gray-700 hidden font-mono text-sm">
                    <thead class="bg-gray-900 border-b-2 border-cyan-400/70">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">Doc ID</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-2/12">LOCATION</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-2/12">MAT</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-2/12">NLOCATION</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">QT</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">TID</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-3/12">TIME (UTC)</th>
                        </tr>
                    </thead>
                    <tbody id="kanban-tbody" class="divide-y divide-gray-700">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
                <p id="no-data-message" class="text-center text-gray-400 py-8 hidden">No documents found in the 'kanban' collection. (Check security rules if you expect data)</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-5Hjv6WZGU6jjGvzbNQGZq1N5eTxhS-4",
            authDomain: "kanban-171e6.firebaseapp.com",
            projectId: "kanban-171e6",
            storageBucket: "kanban-171e6.firebasestorage.app",
            messagingSenderId: "131597045172",
            appId: "1:131597045172:web:27177f11d68e495fbbb6e1"
        };
        
        let db = null;
        
        // Set Firebase logging level for debugging
        setLogLevel('Debug');

        const statusMessageElement = document.getElementById('status-message');
        const kanbanTable = document.getElementById('kanban-table');
        const kanbanTbody = document.getElementById('kanban-tbody');
        const loadingMessage = document.getElementById('loading-message');
        const noDataMessage = document.getElementById('no-data-message');

        // Helper function to format timestamp 
        const formatTimestamp = (timestamp) => {
            if (timestamp) {
                if (typeof timestamp.toDate === 'function') {
                    // Firestore Timestamp
                    return timestamp.toDate().toLocaleString('en-US', { timeZone: 'UTC', year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                if (typeof timestamp === 'number') {
                    // Unix timestamp in milliseconds
                    return new Date(timestamp).toLocaleString('en-US', { timeZone: 'UTC', year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                // Assume it's a raw string if it has no .toDate method
                return String(timestamp);
            }
            return 'N/A';
        };

        // Function to listen for real-time updates from the 'kanban' collection
        const setupKanbanListener = () => {
            const kanbanCollectionRef = collection(db, 'kanban');
            const q = query(kanbanCollectionRef);

            // Use onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                kanbanTbody.innerHTML = '';
                
                if (snapshot.empty) {
                    kanbanTable.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                    return;
                }

                noDataMessage.classList.add('hidden');
                kanbanTable.classList.remove('hidden');

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    
                    const row = kanbanTbody.insertRow();
                    // Dark row background with a cyan hover effect
                    row.className = 'bg-gray-800 transition duration-150 ease-in-out hover:bg-gray-700/50 hover:shadow-inner hover:shadow-cyan-400/50';

                    // 1. Doc ID (truncated)
                    row.insertCell().innerHTML = `<span class="text-xs font-mono text-gray-500">${docId.substring(0, 8)}...</span>`;
                    
                    // 2. LOCATION
                    row.insertCell().textContent = data.LOCATION || '---';
                    
                    // 3. MAT
                    row.insertCell().textContent = data.MAT || '---';
                    
                    // 4. NLOCATION
                    row.insertCell().textContent = data.NLOCATION || '---';

                    // 5. QT (Quantity) - Using text-yellow for numeric data focus
                    const qtCell = row.insertCell();
                    qtCell.className = 'text-yellow-400 font-bold';
                    qtCell.textContent = data.QT || '0';

                    // 6. TID (Transaction ID)
                    row.insertCell().textContent = data.TID || 'N/A';
                    
                    // 7. TIME 
                    const timeCell = row.insertCell();
                    timeCell.className = 'text-xs text-cyan-400 font-mono';
                    timeCell.textContent = formatTimestamp(data.TIME);
                });

            }, (error) => {
                console.error("Error listening to kanban collection: ", error);
                loadingMessage.classList.add('hidden');
                kanbanTable.classList.add('hidden');
                
                let errorMessage;
                if (error.code === 'permission-denied') {
                    errorMessage = "ACCESS DENIED (Error 403). Set the Firestore Security Rule for 'kanban' to 'allow read: if true;' to enable viewing.";
                } else {
                    errorMessage = `SYSTEM ERROR: ${error.message}`;
                }

                kanbanTbody.innerHTML = ''; // Clear any partial data
                noDataMessage.classList.remove('hidden');
                noDataMessage.innerHTML = `<p class="text-red-400 font-bold">${errorMessage}</p>`;
            });
        };

        // Main initialization function (IIFE)
        (async () => {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                statusMessageElement.innerHTML = `STATUS: CONNECTED (Project: <span class="font-mono text-cyan-400">${firebaseConfig.projectId}</span>)`;

                // Start listening to the kanban collection
                setupKanbanListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessageElement.textContent = `STATUS: OFFLINE (Initialization Failed)`;
                loadingMessage.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                noDataMessage.innerHTML = `<p class="text-red-400 font-bold">CRITICAL ERROR: Failed to establish Firebase connection. Check console for config errors.</p>`;
            }
        })();

    </script>
</body>
</html>
